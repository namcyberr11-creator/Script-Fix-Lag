-- VUKHOA FIX LAG: GHOST MAP - COLOR BORDER EDITION
local p = game.Players.LocalPlayer
local pgui = p:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")

-- 1. XÓA UI CŨ
if pgui:FindFirstChild("VuKhoa_GhostMode") then pgui.VuKhoa_GhostMode:Destroy() end

-- 2. TẠO GIAO DIỆN
local sg = Instance.new("ScreenGui")
sg.Name = "VuKhoa_GhostMode"
sg.ResetOnSpawn = false
sg.IgnoreGuiInset = true
sg.Parent = pgui

local f = Instance.new("Frame")
f.Size = UDim2.new(0, 160, 0, 70)
f.Position = UDim2.new(0.5, -80, 0.15, 0)
f.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
f.BackgroundTransparency = 0.3
f.Active = true
f.Draggable = true
f.Parent = sg

local corner = Instance.new("UICorner", f)
corner.CornerRadius = UDim.new(0, 10)

-- NÚT BẤM VỚI VIỀN ĐỐI LẬP
local b = Instance.new("TextButton")
b.Size = UDim2.new(0, 40, 0, 40)
b.Position = UDim2.new(0, 15, 0.5, -20)
b.BackgroundColor3 = Color3.new(0, 1, 0) -- Mặc định Xanh
b.Text = ""
b.Parent = f

local bCorner = Instance.new("UICorner", b)
bCorner.CornerRadius = UDim.new(1, 0)

-- TẠO VIỀN (STROKE)
local stroke = Instance.new("UIStroke")
stroke.Thickness = 3
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
stroke.Color = Color3.new(1, 0, 0) -- Mặc định viền Đỏ
stroke.Parent = b

local t = Instance.new("TextLabel")
t.Size = UDim2.new(0, 100, 0, 40)
t.Position = UDim2.new(0, 60, 0.5, -20)
t.Text = "Vũ Khoa Fix Lag\nFPS: ..."
t.TextColor3 = Color3.new(1, 1, 1)
t.BackgroundTransparency = 1
t.TextSize = 13
t.Font = Enum.Font.SourceSansBold
t.Parent = f

-- 3. LOGIC ẨN MAP
local active = true

local function SetInvisible(v)
    if not active then return end
    pcall(function()
        if v:IsA("BasePart") and not v:IsDescendantOf(p.Character) then
            -- Giữ lại quái/NPC
            local isNPC = v.Parent:FindFirstChild("Humanoid") or (v.Parent.Parent and v.Parent.Parent:FindFirstChild("Humanoid"))
            if not isNPC then
                v.Transparency = 1
                v.CastShadow = false
            end
        elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") then
            v.Enabled = false
        end
    end)
end

-- Tự động check khi có đảo mới
workspace.DescendantAdded:Connect(function(v)
    if active then SetInvisible(v) end
end)

-- Quét toàn bộ map định kỳ
task.spawn(function()
    while true do
        if active then
            for _, v in pairs(workspace:GetDescendants()) do
                if v:IsA("BasePart") and v.Transparency < 1 then SetInvisible(v) end
            end
        end
        task.wait(2)
    end
end)

-- 4. ĐIỀU KHIỂN & ĐỔI MÀU VIỀN
b.MouseButton1Click:Connect(function()
    active = not active
    if active then
        b.BackgroundColor3 = Color3.new(0, 1, 0) -- Nút Xanh
        stroke.Color = Color3.new(1, 0, 0)        -- Viền Đỏ
        for _, v in pairs(workspace:GetDescendants()) do SetInvisible(v) end
    else
        b.BackgroundColor3 = Color3.new(1, 0, 0) -- Nút Đỏ
        stroke.Color = Color3.new(0, 1, 0)        -- Viền Xanh
        -- Hiện lại map
        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("BasePart") and not v:IsDescendantOf(p.Character) then v.Transparency = 0 end
        end
    end
end)

-- FPS Counter
RunService.RenderStepped:Connect(function(dt)
    t.Text = "Vũ Khoa Fix Lag\nFPS: " .. math.floor(1/dt)
end)

-- 5. AUTO JOIN MARINE & START
task.spawn(function()
    local r = game:GetService("ReplicatedStorage")
    while not p.Team or p.Team.Name ~= "Marines" do
        pcall(function() r.Remotes.CommF_:InvokeServer("SetTeam", "Marines") end)
        task.wait(0.5)
    end
    task.wait(1.8)
    for _, v in pairs(workspace:GetDescendants()) do SetInvisible(v) end
end)
